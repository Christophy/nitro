name: CI

on:
  workflow_dispatch: # allows manual triggering
    inputs:
      create_release:
        description: 'Create new release'
        required: true
        type: boolean
  push:
    branches:
      - master
      - 35-add-github-action-for-nitro-build
    paths: ['.github/workflows/**', '**/CMakeLists.txt', '**/Makefile', '**/*.h', '**/*.hpp', '**/*.c', '**/*.cpp', '**/*.cu']
  pull_request:
    types: [opened, synchronize, reopened]
    paths: ['**/CMakeLists.txt', '**/Makefile', '**/*.h', '**/*.hpp', '**/*.c', '**/*.cpp', '**/*.cu']

env:
  BRANCH_NAME: ${{ github.head_ref || github.ref_name }}

jobs:
  ubuntu-amd64-build:
    runs-on: ubuntu-20.04
    permissions:
      contents: write
    steps:
      - name: Clone
        id: checkout
        uses: actions/checkout@v3
        with:
          submodules: recursive

      - name: Dependencies
        id: depends
        run: |
          sudo apt-get update
          sudo apt-get install build-essential gcc-8

      - name: Build
        id: make_build
        run: |
          ./install_deps.sh
          mkdir build && cd build
          cmake ..
          CC=gcc-8 make -j $(nproc)
          ls -la

      - name: Upload binaries to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: build/nitro
          asset_name: nitro-linux-amd64
          tag: ${{ github.ref }}

  ubuntu-amd64-cuda-build:
    runs-on: linux-gpu
    permissions:
      contents: write
    steps:
      - name: Clone
        id: checkout
        uses: actions/checkout@v3
        with:
          submodules: recursive

      # - name: Dependencies
      #   id: depends
      #   run: |
      #     sudo apt-get update
      #     sudo apt-get install build-essential gcc-8

      - name: Build
        id: make_build
        run: |
          ./install_deps.sh
          mkdir build && cd build
          cmake -DLLAMA_CUBLAS=ON ..
          CC=gcc-8 make -j $(nproc)
          ls -la   

      - name: Upload binaries to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: build/nitro
          asset_name: nitro-linux-amd64-cuda
          tag: ${{ github.ref }}

  macOS-M-build:
    runs-on: mac-silicon
    permissions:
      contents: write
    steps:
      - name: Clone
        id: checkout
        uses: actions/checkout@v3
        with:
          submodules: recursive

      - name: Dependencies
        id: depends
        continue-on-error: true
        run: |
          brew update

      - name: Build
        id: cmake_build
        run: |
          ./install_deps.sh
          mkdir build && cd build
          cmake .. 
          CC=gcc-8 make -j $(nproc)
          ls -la

      - name: Upload binaries to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: build/nitro
          asset_name: nitro-mac-arm64-metal
          tag: ${{ github.ref }}

  macOS-Intel-build:
    runs-on: macos-latest
    permissions:
      contents: write
    steps:
      - name: Clone
        id: checkout
        uses: actions/checkout@v3
        with:
          submodules: recursive

      - name: Dependencies
        id: depends
        continue-on-error: true
        run: |
          brew update

      - name: Build
        id: cmake_build
        run: |
          ./install_deps.sh
          mkdir build && cd build
          cmake -DLLAMA_METAL=OFF .. 
          CC=gcc-8 make -j $(nproc)
          ls -la

      - name: Upload binaries to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: build/nitro
          asset_name: nitro-mac-amd64
          tag: ${{ github.ref }}